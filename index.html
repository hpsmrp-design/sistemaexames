<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gerador de Exames ‚Äì HP (Cat√°logo Completo+)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root{--brand:#05488c;--brand2:#2da3d5;--brand3:#acd6e9;--ink:#0b2440;--muted:#5b728d;--line:#e6eef6;--card:#ffffff}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#fff 0%,#f4fbff 100%);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px dashed var(--line)}
header .wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.logo{display:inline-flex;gap:10px;align-items:center;color:#05488c;padding:6px 12px;border-radius:20px;font-weight:800}
main{max-width:1200px;margin:0 auto;padding:14px}
.grid{display:grid;grid-template-columns:380px 1fr;gap:14px}@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px dashed var(--line);border-radius:22px;padding:12px;box-shadow:0 12px 40px rgba(5,72,140,.08)}
label{display:block;color:#3d556e;font-size:.9rem;margin:8px 0 6px}
input,select,textarea{width:100%;padding:.7rem .9rem;border:1px dashed var(--line);border-radius:14px;background:#fff}
textarea{min-height:90px;resize:vertical}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px dashed var(--line);border-radius:14px;background:#fff;padding:.7rem 1rem;cursor:pointer;font-weight:700}
.btn:hover{background:#f8fcff}.btn-primary{background:linear-gradient(135deg,var(--brand) 0%,var(--brand2) 100%);color:#fff;border:none}
.btn-primary:hover{filter:brightness(.98)}
.list{max-height:520px;overflow:auto;border:1px dashed var(--line);border-radius:16px;padding:6px;background:#fff}
.item{padding:10px;border-radius:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:1px dashed transparent}
.item small{color:#5b728d}.item:hover{background:#f7fbff;border-color:#d7ecfb}.sel{background:#f7fbff;border-color:#d7ecfb}
.paper{width:860px;min-height:1180px;margin:0 auto;background:#fff;border:2px dashed var(--line);border-radius:28px;padding:0 0 28px;position:relative;overflow:hidden}
.doc-head{padding:22px 24px;background:linear-gradient(180deg,#fff 0%,#f6fbff 80%);border-bottom:1px dashed var(--line);display:grid;grid-template-columns:1fr auto;gap:12px}
.doc-brand{display:flex;gap:12px;align-items:center}.doc-title{font-weight:800;color:#05488c}
.meta{font-size:.9rem;color:#5b728d;display:flex;gap:12px;align-items:center}
.meta .pill{background:#eaf6ff;border:1px dashed var(--line);padding:3px 10px;border-radius:999px;color:#0f172a}
.hr{border-top:1px dashed var(--line);margin:10px 0}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.box{border:1px dashed var(--line);border-radius:14px;padding:10px;background:#fff}
.section-title{display:flex;align-items:center;gap:10px;margin:10px 0 8px}.section-title .dot{width:12px;height:12px;border-radius:999px;background:#2da3d5;box-shadow:0 0 0 4px #acd6e9}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.thumb{border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#fff}
.thumb img{width:100%;aspect-ratio:4/3;object-fit:contain;background:#0b1220}
.thumb footer{display:flex;gap:6px;border-top:1px dashed var(--line);padding:6px}
.drop{border:2px dashed #acd6e9;border-radius:14px;padding:12px;text-align:center;color:#05488c;background:#f6fbff}
.sigline{height:58px;border-bottom:1px dashed #bddcf0;margin-bottom:6px;position:relative}
.sigimg{position:absolute;left:50%;transform:translateX(-50%);top:-6px;height:80px;object-fit:contain;opacity:.95;display:none}
footer.doc{position:absolute;left:0;right:0;bottom:0;padding:12px 24px;display:flex;justify-content:space-between;color:#475569;font-size:.85rem;border-top:1px dashed var(--line);background:#f6fbff}
.badge-soft{display:inline-block;background:#eaf6ff;border:1px dashed var(--line);padding:4px 12px;border-radius:999px}
.small{font-size:.9rem;color:#6b7280}.table{border:1px solid #e6edf6;border-radius:12px;overflow:hidden}
.table header,.table .row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:6px;align-items:center}
.table header{background:#f0f8ff;color:#05488c;font-weight:700;padding:8px 10px;border-bottom:1px solid #e6edf6}
.table .row{padding:6px 10px;border-bottom:1px dashed #e6edf6}.hide{display:none}
</style>
</head>
<body>
<header><div class="wrap"><div class="logo">Gerador de Exames ‚Äì HP</div></div></header>

<main class="grid">
  <aside class="card">
    <div class="grid2">
      <select id="cat"></select>
      <input id="q" placeholder="Buscar exame por nome ou ID"/>
    </div>
    <div id="list" class="list" style="margin-top:8px"></div>
    <div class="hr"></div>

    <label>Unidade</label>
    <select id="unidSel">
      <option selected>HP Santa Marcelina ‚Äì Centro de Imagem</option>
      <option>HP Santa Marcelina ‚Äì Laborat√≥rio de An√°lises Cl√≠nicas</option>
      <option>HP Santa Marcelina ‚Äì Cardiologia (ECG / MAPA / Holter / Eco)</option>
      <option>HP Santa Marcelina ‚Äì Neurologia (EEG / EMG / Potenciais)</option>
      <option>HP Santa Marcelina ‚Äì Obstetr√≠cia & Ginecologia (USG)</option>
      <option>HP Santa Marcelina ‚Äì Oftalmologia (Diagn√≥stico)</option>
      <option>HP Santa Marcelina ‚Äì Otorrinolaringologia (Audiologia)</option>
      <option>HP Santa Marcelina ‚Äì Dermatologia (Procedimentos / Bi√≥psias)</option>
      <option>HP Santa Marcelina ‚Äì Endocrinologia (Ambulat√≥rio)</option>
      <option>HP Santa Marcelina ‚Äì Ortopedia (Imagem M√∫sculoesquel√©tica)</option>
      <option>HP Santa Marcelina ‚Äì Traumatologia (Urg√™ncia)</option>
      <option>HP Santa Marcelina ‚Äì Oncologia (Quimioterapia / Patologia)</option>
      <option>HP Santa Marcelina ‚Äì Fisioterapia (Reabilita√ß√£o)</option>
      <option>HP Santa Marcelina ‚Äì Administra√ß√£o (Atestados/Relat√≥rios)</option>
      <option>Outra...</option>
    </select>
    <input id="unid" class="hide" placeholder="Digite o nome da unidade"/>

    <label>Data</label><input id="data" placeholder="dd/mm/aaaa hh:mm">
    <label>Paciente</label><input id="paciente" placeholder="Nome completo">
    <div class="grid2">
      <input id="doc" placeholder="Passaporte/ID"><input id="idade" placeholder="Idade">
    </div>
    <div class="grid2">
      <input id="sangue" placeholder="Tipo sangu√≠neo"><input id="contato" placeholder="Telefone (055)">
    </div>
    <label>Profissional</label>
    <div class="grid2">
      <input id="medico" placeholder="Nome do profissional"><input id="crm" placeholder="Registro (CRM/CRP/CREFITO‚Ä¶)">
    </div>
    <div class="hr"></div>

    <strong>Assinatura do profissional</strong>
    <div class="grid2" style="align-items:center">
      <div id="sigPrev" class="box" style="height:56px;display:grid;place-items:center;color:#64748b">sem assinatura</div>
      <div class="controls">
        <button id="bSigUp" class="btn">Carregar imagem</button>
        <button id="bSigSave" class="btn">Salvar p/ este registro</button>
      </div>
      <input id="sigFile" type="file" accept="image/*" style="display:none">
    </div>

    <div class="hr"></div>
    <strong>Campos do exame</strong>
    <div id="fields"></div>

    <div class="hr"></div>
    <strong>Imagens do exame</strong> <span class="small">(aparece para exames com imagem)</span>
    <div id="drop" class="drop">Arraste imagens ou clique</div>
    <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
    <div id="thumbs" class="gallery" style="margin-top:8px"></div>

    <div class="hr"></div>
    <div class="grid2">
      <button id="bRender" class="btn">Atualizar laudo</button>
      <div class="controls">
        <button id="bPNG" class="btn btn-primary">Gerar PNG</button>
        <a id="dl" class="btn" download="exame.png">Baixar PNG</a>
      </div>
    </div>
  </aside>

  <section class="card">
    <div id="paper" class="paper">
      <div class="doc-head">
        <div class="doc-brand">
          <div class="doc-title" id="v_unid">‚Äî</div>
        </div>
        <div class="meta">
          <div>Data <span id="v_data" class="pill">‚Äî</span></div>
          <div>N¬∫ Exame <span id="v_num" class="pill">‚Äî</span></div>
        </div>
      </div>

      <div style="padding:16px 24px">
        <div class="grid3">
          <div class="box"><div class="small">Paciente</div><strong id="v_paciente">‚Äî</strong></div>
          <div class="box"><div class="small">Passaporte/ID</div><strong id="v_doc">‚Äî</strong></div>
          <div class="box"><div class="small">Idade</div><strong id="v_idade">‚Äî</strong></div>
          <div class="box"><div class="small">Tipo sangu√≠neo</div><strong id="v_sangue">‚Äî</strong></div>
          <div class="box"><div class="small">Contato</div><strong id="v_contato">‚Äî</strong></div>
          <div class="box"><div class="small">Profissional / Registro</div><strong><span id="v_medico">‚Äî</span> / <span id="v_crm">‚Äî</span></strong></div>
        </div>
        <div class="hr"></div>

        <div><span class="small">Modelo:</span> <span id="v_title" class="badge-soft"></span>
          <span class="small" style="margin-left:8px">Tag:</span> <span id="v_tag" class="badge-soft"></span>
        </div>

        <div id="view" class="box" style="margin-top:8px"></div>

        <div id="secImgs" style="display:none">
          <div class="section-title"><span class="dot"></span><strong>Imagens</strong></div>
          <div id="viewGallery" class="gallery" style="margin-top:8px"></div>
        </div>

        <div class="hr"></div>
        <div class="box">
          <div class="sigline"><img id="sigImg" class="sigimg" alt=""></div>
          <div style="text-align:center;color:#64748b;font-size:.9rem">Assinatura ‚Äì <span id="sigM">‚Äî</span> (Registro <span id="sigC">‚Äî</span>)</div>
        </div>
      </div>

      <footer class="doc">
        <div>Documento amig√°vel ‚Ä¢ <span id="v_code">‚Äî</span></div>
        <div>Gerado digitalmente ‚Ä¢ V√°lido sem assinatura f√≠sica</div>
      </footer>
    </div>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);
const el=h=>{const d=document.createElement('div'); d.innerHTML=h; return d.firstElementChild;};
const IMG_CATS=new Set(["ü©π Dermatologia","ü´Ñ Obstetr√≠cia","‚ù§Ô∏è Cardiologia","üëÄ Oftalmologia","üëÇ Otorrino","ü¶¥ Ortopedia","üß© Neurologia","RX","TC","RM","USG"]);
const CATS=["üß™ Laborat√≥rio","‚ù§Ô∏è Cardiologia","üß© Neurologia","ü´Ñ Obstetr√≠cia","üë© Ginecologia","ü¶¥ Ortopedia","üöë Traumatologia","üë• Psicologia","üß† Psiquiatria","ü©π Dermatologia","üî¨ Endocrinologia","üëÄ Oftalmologia","üëÇ Otorrino","üß¨ Oncologia","RX","TC","RM","USG","ü¶ø Fisioterapia"];
function area(id,cat,name,fields){return {id,cat,name,fields};}
function tInput(id,label,val=""){return {type:"input",id,label,value:val};}
function tSelect(id,label,options,val){return {type:"select",id,label,options,value:val};}
function tText(id,label,val=""){return {type:"textarea",id,label,value:val};}
function tChecks(id,label,options){return {type:"checkboxes",id,label,options};}
function tDynamic(id,label){return {type:"dynamic",id,label};}

/* ===== CAT√ÅLOGO COMPLETO+ ===== */
const CATALOG=[
  // LAB
  area("lab_hemo","üß™ Laborat√≥rio","Hemograma Completo",[tInput("hb","Hemoglobina (g/dL)"),tInput("ht","Hemat√≥crito (%)"),tInput("leuco","Leuc√≥citos (/mm¬≥)"),tInput("neut","Neutr√≥filos (%)"),tInput("linf","Linf√≥citos (%)"),tInput("plaquetas","Plaquetas (/mm¬≥)"),tText("imp","Impress√£o")]),
  area("lab_pcr","üß™ Laborat√≥rio","PCR / VHS",[tInput("pcr","PCR (mg/L)"),tInput("vhs","VHS (mm/h)"),tText("imp","Impress√£o")]),
  area("lab_renal","üß™ Laborat√≥rio","Fun√ß√£o Renal",[tInput("ureia","Ureia (mg/dL)"),tInput("creat","Creatinina (mg/dL)"),tInput("egfr","eGFR (mL/min/1.73m¬≤)"),tText("imp","Impress√£o")]),
  area("lab_hep","üß™ Laborat√≥rio","Fun√ß√£o Hep√°tica",[tInput("tgo","TGO/AST (U/L)"),tInput("tgp","TGP/ALT (U/L)"),tInput("ggt","GGT (U/L)"),tInput("bt","Bilirrubina total (mg/dL)"),tInput("bd","Bilirrubina direta (mg/dL)"),tText("imp","Impress√£o")]),
  area("lab_lipid","üß™ Laborat√≥rio","Perfil Lip√≠dico",[tInput("colt","Colesterol total (mg/dL)"),tInput("ldl","LDL (mg/dL)"),tInput("hdl","HDL (mg/dL)"),tInput("tg","Triglicer√≠deos (mg/dL)"),tText("imp","Impress√£o")]),
  area("lab_glic","üß™ Laborat√≥rio","Glicemia / HbA1c",[tInput("glic","Glicemia (mg/dL)"),tInput("hba1c","HbA1c (%)"),tText("imp","Impress√£o")]),
  area("lab_ureia_creat","üß™ Laborat√≥rio","Ureia/Creatinina Urin√°ria 24h",[tInput("vol","Volume 24h (mL)"),tInput("ureiaU","Ureia (mg/dL)"),tInput("creatU","Creatinina (mg/dL)"),tText("imp","Impress√£o")]),
  area("lab_tireo","üß™ Laborat√≥rio","Painel Tireoidiano",[tInput("tsh","TSH (¬µUI/mL)"),tInput("t4l","T4 Livre (ng/dL)"),tInput("t3","T3 (ng/dL)"),tText("imp","Impress√£o")]),
  area("lab_betahcg","üß™ Laborat√≥rio","Beta-HCG Quantitativo",[tSelect("amostra","Tipo de amostra",["Soro","Urina"],"Soro"),tInput("metodo","M√©todo"),tInput("resultado","Resultado (mUI/mL)"),tText("refer","Valores de refer√™ncia"),tText("interpret","Interpreta√ß√£o")]),
  area("adm_atestado","üß™ Laborat√≥rio","Atestado M√©dico",[tText("texto","Texto do atestado"),tInput("dias","Dias de afastamento"),tInput("cid","CID (opcional)"),tText("obs","Observa√ß√µes")]),
  area("lab_dna","üß™ Laborat√≥rio","Teste de DNA ‚Äì Paternidade (multi)",[tSelect("tipo","Tipo",["Paternidade","Maternidade","Irmindade"]),tDynamic("participantes","Participantes (Nome, Parentesco, Amostra)"),tInput("prob","Probabilidade (%)"),tText("laudo","Texto descritivo / Observa√ß√µes")]),

  // CARDIO
  area("card_ecg","‚ù§Ô∏è Cardiologia","ECG",[tInput("fc","FC (bpm)"),tInput("pr","PR (ms)"),tInput("qrs","QRS (ms)"),tInput("qtc","QTc (ms)"),tSelect("ritmo","Ritmo",["Sinusal","Arritmia sinusal","FA"]),tText("imp","Impress√£o"),tText("conduta","Conduta")]),
  area("card_teste","‚ù§Ô∏è Cardiologia","Teste Ergom√©trico",[tInput("protoc","Protocolo (ex.: Bruce)"),tInput("dur","Dura√ß√£o/est√°gio"),tInput("fcmax","FC m√°x (bpm)"),tInput("pa","PA pico (mmHg)"),tText("st","ST/arr√≠tmias"),tText("sint","Sintomas/Interrup√ß√£o"),tText("imp","Impress√£o/conduta")]),
  area("card_mapa24","‚ù§Ô∏è Cardiologia","MAPA 24h",[tText("medias","PA m√©dia/cargas"),tText("imp","Impress√£o")]),
  area("card_mapa48","‚ù§Ô∏è Cardiologia","MAPA 48h",[tText("medias","PA m√©dia/cargas"),tText("imp","Impress√£o")]),
  area("card_holter","‚ù§Ô∏è Cardiologia","Holter 24h",[tText("ritmos","Ritmos/FC m√©dia"),tText("pausas","Pausas/taquiarritmias"),tText("imp","Impress√£o")]),
  area("card_eco_dopp","‚ù§Ô∏è Cardiologia","Ecocardiograma com Doppler",[tInput("fe","Fra√ß. eje√ß√£o (%)"),tText("valvas","Valvas/gradientes"),tText("cam","C√¢maras/hipertrofias"),tText("imp","Impress√£o")]),

  // NEURO
  area("neuro_eeg","üß© Neurologia","EEG ‚Äì Laudo",[tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("neuro_emg","üß© Neurologia","EMG/NCV ‚Äì Relat√≥rio",[tText("musc","M√∫sculos/nerveos"),tText("res","Resultado"),tText("imp","Impress√£o")]),
  area("neuro_pot","üß© Neurologia","Potenciais Evocados",[tSelect("modal","Modalidade",["Auditivo","Visual","Motor"]),tText("param","Par√¢metros/lat√™ncias"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("neuro_exam","üß© Neurologia","Exame Neurol√≥gico + Glasgow",[tInput("glasgow","Glasgow (3‚Äì15)"),tText("neuro","Exame neurol√≥gico"),tText("imp","Impress√£o")]),

  // OBST/GINE
  area("obs_morfo","ü´Ñ Obstetr√≠cia","USG Morfol√≥gica 2¬∫ tri ‚Äì Resumo",[tInput("ig","IG (semanas)"),tText("biometria","Biometria"),tText("anatomia","Anatomia fetal"),tText("imp","Impress√£o")]),
  area("obs_dopp","ü´Ñ Obstetr√≠cia","USG Obst√©trica com Doppler",[tInput("ig","IG (semanas)"),tText("umb","Umbilical"),tText("cmed","Cerebral m√©dio"),tText("uterinas","Uterinas"),tText("imp","Impress√£o")]),
  area("obs_bnsg","ü´Ñ Obstetr√≠cia","Perfil Biof√≠sico/FCF",[tInput("pbf","PBF (0‚Äì8)"),tText("fcf","FCF/variabilidade"),tText("imp","Impress√£o")]),
  area("gine_usg_tv","üë© Ginecologia","USG Transvaginal ‚Äì Resumo",[tText("utero","√ötero/endom√©trio"),tText("ovarios","Ov√°rios"),tText("imp","Impress√£o")]),
  area("gine_colpo","üë© Ginecologia","Colposcopia",[tText("ach","Achados"),tText("biopsia","Bi√≥psias"),tText("imp","Impress√£o")]),
  area("gine_preventivo","üë© Ginecologia","Preventivo ‚Äì Resultado",[tText("macro","Macroscopia"),tText("micro","Microscopia"),tText("diag","Diagn√≥stico")]),
  area("gine_ist","üë© Ginecologia","Painel IST ‚Äì Resumo",[tText("res","Resultados"),tText("trat","Tratamento"),tText("orient","Orienta√ß√µes")]),

  // DERMATO
  area("dermo_lesao","ü©π Dermatologia","Les√£o Cut√¢nea",[tText("local","Localiza√ß√£o"),tText("pads","Padr√µes cl√≠nicos/dermatosc√≥picos"),tText("imp","Impress√£o"),tText("conduta","Conduta")]),
  area("dermo_biopsia","ü©π Dermatologia","Bi√≥psia de Pele ‚Äì Laudo",[tText("macro","Macroscopia"),tText("micro","Microscopia"),tText("margens","Margens"),tText("diag","Diagn√≥stico")]),
  area("dermo_alergia","ü©π Dermatologia","Patch Test ‚Äì Teste Al√©rgico",[tText("reg","Regi√µes testadas"),tText("reac","Rea√ß√µes"),tText("imp","Impress√£o")]),

  // ENDO
  area("endo_diab","üî¨ Endocrinologia","Diabetes ‚Äì Acompanhamento",[tInput("hba1c","HbA1c (%)"),tText("glic","Glicemias/hipos"),tText("plano","Plano terap√™utico")]),
  area("endo_tireoide","üî¨ Endocrinologia","Tireoide ‚Äì Resumo",[tInput("tsh","TSH"),tInput("t4l","T4L"),tInput("t3","T3"),tText("imp","Impress√£o")]),
  area("endo_obes","üî¨ Endocrinologia","Obesidade ‚Äì Conduta",[tText("aval","Avalia√ß√£o"),tText("plano","Plano")]),

  // OFTALMO
  area("oft_refra","üëÄ Oftalmologia","Refra√ß√£o/Acuidade",[tText("od","OD"),tText("oe","OE"),tText("imp","Impress√£o")]),
  area("oft_fundo","üëÄ Oftalmologia","Fundoscopia ‚Äì Achados",[tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("oft_gonio","üëÄ Oftalmologia","Tonometria/Gonioscopia",[tInput("tio","TIO (mmHg)"),tText("ang","√Çngulo"),tText("imp","Impress√£o")]),

  // OTORRINO
  area("oto_audi","üëÇ Otorrino","Audiometria",[tText("lim","Limiares"),tText("fala","Teste de fala"),tText("imp","Impress√£o")]),
  area("oto_timpan","üëÇ Otorrino","Timpanometria",[tText("curva","Curvas"),tText("refl","Reflexos"),tText("imp","Impress√£o")]),
  area("oto_endosc","üëÇ Otorrino","Nasofibroscopia ‚Äì Relat√≥rio",[tText("ach","Achados"),tText("imp","Impress√£o"),tText("conduta","Conduta")]),

  // ONCO
  area("onco_quimio","üß¨ Oncologia","Ciclo de Quimioterapia ‚Äì Evolu√ß√£o",[tText("esq","Esquema"),tText("tox","Toxicidades"),tText("imp","Impress√£o")]),
  area("onco_biopsia","üß¨ Oncologia","Bi√≥psia ‚Äì Patologia",[tText("macro","Macroscopia"),tText("micro","Microscopia"),tText("margens","Margens"),tText("diag","Diagn√≥stico")]),

  // ORTOP/TRAUMA
  area("orto_joelho_rx","ü¶¥ Ortopedia","RX Joelho ‚Äì Laudo",[tText("ach","Achados"),tText("imp","Impress√£o"),tText("conduta","Conduta")]),
  area("orto_coluna_rx","ü¶¥ Ortopedia","RX Coluna ‚Äì Laudo",[tText("ach","Achados"),tText("imp","Impress√£o"),tText("conduta","Conduta")]),
  area("orto_ombro_usg","ü¶¥ Ortopedia","USG Ombro ‚Äì Manguito",[tText("tend","Tend√µes"),tText("bursa","Bursas"),tText("imp","Impress√£o")]),
  area("trauma_urg","üöë Traumatologia","Atendimento de Urg√™ncia",[tText("mec","Mecanismo do trauma"),tText("les","Les√µes observadas"),tText("conduta","Conduta/Encaminhamentos")]),
  area("trauma_retorno","üöë Traumatologia","Reavalia√ß√£o P√≥s-Trauma",[tText("evo","Evolu√ß√£o"),tText("imgs","Exames/Imagens"),tText("plano","Plano")]),

  // RX (completo)
  area("rx_torax","RX","RX T√≥rax PA",[tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_cranio","RX","RX Cr√¢nio",[tInput("inc","Incid√™ncias"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_face","RX","RX Seios da Face",[tInput("inc","Incid√™ncias"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_cervical","RX","RX Coluna Cervical",[tSelect("pos","Posicionamento",["AP/Perfil","AP/Perfil + Odontoide","Flex/Ext"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_toracica","RX","RX Coluna Tor√°cica",[tInput("inc","Incid√™ncias"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_lombar","RX","RX Coluna Lombar",[tSelect("serie","S√©rie",["AP/Perfil","AP/Perfil + Obl√≠quas","Din√¢micas"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_sacro","RX","RX Sacro-C√≥ccix",[tInput("inc","Incid√™ncias"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_total","RX","RX Coluna Total (Escoliose)",[tInput("met","M√©todo (Cobb)"),tText("curvas","Curvaturas/√¢ngulos"),tText("imp","Impress√£o")]),
  area("rx_quadril","RX","RX Quadril/Bacia",[tSelect("lat","Lateralidade",["Direito","Esquerdo","Bilateral"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_ombro","RX","RX Ombro",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tInput("inc","AP, Y, axial"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_cotovelo","RX","RX Cotovelo",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_punho","RX","RX Punho/M√£o/Dedos",[tSelect("seg","Segmento",["Punho","M√£o","Dedos"]),tSelect("lat","Lateralidade",["Direito","Esquerdo","Bilateral"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_braco","RX","RX Bra√ßo (√ömero)",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tInput("inc","Incid√™ncias (AP/Perfil)"),tText("alin","Alinhamento/tra√ßo"),tText("partes","Partes moles"),tText("imp","Impress√£o")]),
  area("rx_antebraco","RX","RX Antebra√ßo (R√°dio/Ulna)",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tInput("inc","Incid√™ncias (AP/Perfil)"),tText("art","Cotovelo/punho"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_joelho","RX","RX Joelho",[tSelect("lat","Lateralidade",["Direito","Esquerdo","Bilateral"]),tInput("inc","AP/perfil/axial"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_femur","RX","RX F√™mur",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tInput("inc","Incid√™ncias (AP/Perfil)"),tText("alin","Alinhamento/cominutivas"),tText("setor","Colo/di√°fise/distal"),tText("imp","Impress√£o")]),
  area("rx_tornozelo","RX","RX Tornozelo/P√©",[tSelect("seg","Segmento",["Tornozelo","P√©"]),tSelect("lat","Lateralidade",["Direito","Esquerdo","Bilateral"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_perna","RX","RX Perna (T√≠bia/F√≠bula)",[tSelect("lat","Lateralidade",["Direito","Esquerdo"]),tInput("inc","Incid√™ncias (AP/Perfil)"),tText("art","Joelho/tornozelo"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_clav","RX","RX Clav√≠cula",[tSelect("lat","Lateralidade",["Direita","Esquerda"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_cost","RX","RX Costelas",[tSelect("lat","Lado",["Direitas","Esquerdas","Bilaterais"]),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rx_abd","RX","RX Abdome Agudo",[tSelect("inc","Incid√™ncias",["Supino","Orto/Dec√∫bito","S√©rie abdome agudo"]),tText("alca","Al√ßas/n√≠veis"),tText("ar","Ar livre"),tText("imp","Impress√£o")]),

  // TC / RM / USG
  area("tc_cranio","TC","TC Cr√¢nio s/contraste",[tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("tc_torax","TC","TC T√≥rax",[tText("ach","Par√™nquima/mediastino/vasos"),tText("imp","Impress√£o")]),
  area("tc_abd","TC","TC Abdome/Pelve c/contraste",[tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rm_lombar","RM","RM Coluna Lombar",[tText("discos","Discos/forames/canal"),tText("ach","Achados"),tText("imp","Impress√£o")]),
  area("rm_joelho","RM","RM Joelho",[tText("ligam","Ligamentos/meniscos"),tText("cart","Cartilagem/edema √≥sseo"),tText("imp","Impress√£o")]),
  area("rm_ombro","RM","RM Ombro",[tText("manguito","Manguito/b√≠ceps"),tText("labro","L√°bro/c√°psula"),tText("imp","Impress√£o")]),
  area("usg_abd","USG","USG Abdome Total",[tText("hep","F√≠gado/VB/p√¢ncreas"),tText("ren","Rins/vias urin√°rias"),tText("imp","Impress√£o")]),
  area("usg_tireo","USG","USG Tireoide",[tText("parenq","Par√™nquima/linfonodos"),tText("nod","N√≥dulos/TIRADS"),tText("imp","Impress√£o")]),
  area("usg_pelv","USG","USG P√©lvico (fem/masc)",[tSelect("sexo","Sexo",["Feminino","Masculino"]),tText("orgaos","√ìrg√£os/achados"),tText("imp","Impress√£o")]),

  // Psicologia / Psiquiatria / Fisio
  area("psi_triagem","üë• Psicologia","Triagem Psicol√≥gica",[tSelect("risco","Risco atual",["Baixo","Moderado","Alto"]),tSelect("humor","Humor",["Eut√≠mico","Ansioso","Depressivo","Irritado"]),tText("queixa","Queixa principal"),tText("imp","Impress√£o")]),
  area("psi_escuta","üë• Psicologia","Escuta Ativa ‚Äì Registro",[tText("dem","Demanda"),tText("interv","Interven√ß√µes"),tText("plano","Plano/encaminhamentos")]),
  area("psiq_risco","üß† Psiquiatria","Avalia√ß√£o de Risco",[tSelect("ideacao","Idea√ß√£o suicida",["Ausente","Passiva","Ativa sem plano","Ativa com plano"]),tSelect("psicose","Sinais psic√≥ticos",["Ausentes","Presentes"]),tText("subst","Uso de subst√¢ncias"),tText("imp","Impress√£o")]),
  area("fisio_av","ü¶ø Fisioterapia","Avalia√ß√£o Funcional",[tText("queixa","Queixa/Hist√≥ria"),tText("deficits","D√©ficits"),tText("plano","Plano terap√™utico")]),
  area("fisio_evol","ü¶ø Fisioterapia","Evolu√ß√£o de Sess√£o",[tText("proc","Procedimentos realizados"),tText("resp","Resposta do paciente"),tText("plano","Plano para pr√≥xima sess√£o")]),
];
/* ===== fim cat√°logo ===== */

// assinatura
function sigKey(crm){return"sig_"+(crm||"");}
function loadSig(crm){try{return localStorage.getItem(sigKey(crm))||"";}catch(e){return"";}}
function applySignature(data){const prev=$("#sigPrev"); const img=$("#sigImg");
  if(data){prev.innerHTML=`<img src="${data}" style="max-height:52px;max-width:100%">`;img.src=data;img.style.display="block";}
  else{prev.textContent="sem assinatura";img.removeAttribute("src");img.style.display="none";}
}
$("#bSigUp").onclick=()=>$("#sigFile").click();
$("#sigFile").onchange=e=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>applySignature(ev.target.result); r.readAsDataURL(f);};
$("#bSigSave").onclick=()=>{const crm=$("#crm").value.trim(); const prev=$("#sigPrev").querySelector("img");
  if(!crm) return alert("Informe o registro."); if(!prev) return alert("Carregue a imagem da assinatura.");
  localStorage.setItem(sigKey(crm), prev.src); alert("Assinatura salva para "+crm);
};
function refreshSig(){const crm=$("#crm").value.trim(); applySignature(loadSig(crm));}

// unidade: select + "Outra..."
const unidSel=$("#unidSel"); const unidInp=$("#unid");
unidSel.onchange=()=>{ if(unidSel.value==="Outra..."){unidInp.classList.remove("hide"); unidInp.focus();} else {unidInp.classList.add("hide");} render();};
unidInp.oninput=render;

// imagens
function imgKey(id){return"img_"+id;} function loadImgs(id){try{return JSON.parse(localStorage.getItem(imgKey(id))||"[]");}catch(e){return[]}}
function saveImgs(id,a){localStorage.setItem(imgKey(id), JSON.stringify(a));}
function buildGallery(ex){const V=$("#viewGallery"); if(!V) return; V.innerHTML=""; const arr=loadImgs(ex.id); arr.forEach(o=>{V.appendChild(el(`<div class='thumb'><img src='${o.src}'><footer>${o.caption||""}</footer></div>`))});}
function renderThumbs(ex){const T=$("#thumbs"); if(!T) return; T.innerHTML=""; const arr=loadImgs(ex.id);
  arr.slice(0,6).forEach((o,i)=>{const c=el(`<div class="thumb"><img src="${o.src}"><footer><input placeholder="Legenda" value="${o.caption||''}"><button class='btn'>‚úï</button></footer></div>`);
    const inp=c.querySelector("input"); const btn=c.querySelector("button");
    inp.oninput=()=>{const t=loadImgs(ex.id); if(t[i]){t[i].caption=inp.value; saveImgs(ex.id,t); buildGallery(ex);}};
    btn.onclick=()=>{const t=loadImgs(ex.id); t.splice(i,1); saveImgs(ex.id,t); renderThumbs(ex);};
    T.appendChild(c);
  }); buildGallery(ex);
}
function handleFiles(ex,files){const cur=loadImgs(ex.id); const tasks=[];
  Array.from(files).forEach(f=>{if(!f.type.startsWith("image/"))return; if(cur.length+tasks.length>=6) return; const r=new FileReader();
    tasks.push(new Promise(res=>{r.onload=e=>res({src:e.target.result,caption:""}); r.readAsDataURL(f);}));
  });
  Promise.all(tasks).then(newOnes=>{const merged=cur.concat(newOnes).slice(0,6); saveImgs(ex.id,merged); renderThumbs(ex);});
}
$("#drop").onclick=()=>$("#fileInput").click();
$("#fileInput").onchange=e=>{if(current) handleFiles(current,e.target.files);}
$("#drop").ondragover=e=>{e.preventDefault();}; $("#drop").ondrop=e=>{e.preventDefault(); if(current) handleFiles(current,e.dataTransfer.files);};

// listagem/render
const catSel=$("#cat"); ["Todas",...CATS].forEach(c=>catSel.appendChild(el(`<option value="${c}">${c}</option>`)));
function buildList(){const q=($("#q").value||"").toLowerCase(); const c=catSel.value; const L=$("#list"); L.innerHTML="";
  CATALOG.filter(x=>(c==="Todas"||x.cat===c)&&(x.name.toLowerCase().includes(q)||x.id.toLowerCase().includes(q)))
  .forEach(x=>{const it=el(`<div class="item" data-id="${x.id}"><div><small>${x.cat}</small> ‚Ä¢ <strong>${x.name}</strong></div><small>${x.id}</small></div>`); it.onclick=()=>selectExam(x.id); L.appendChild(it);});
}
$("#q").oninput=buildList; catSel.onchange=buildList;

let current=null;
function selectExam(id){
  const ex=CATALOG.find(x=>x.id===id); if(!ex) return; current=ex;
  document.querySelectorAll(".item").forEach(d=>d.classList.toggle("sel", d.getAttribute("data-id")===id));
  $("#v_title").textContent=ex.name; $("#v_tag").textContent=(ex.cat+"-"+ex.id).toUpperCase();
  const F=$("#fields"); F.innerHTML="";
  ex.fields.forEach(f=>{
    if(f.type==="dynamic"){ buildDynamic(f.id); return; }
    let c=""; if(f.type==="input") c=`<input id="f_${f.id}" value="${f.value||''}">`;
    if(f.type==="textarea") c=`<textarea id="f_${f.id}">${f.value||""}</textarea>`;
    if(f.type==="select") c=`<select id="f_${f.id}">${(f.options||[]).map(o=>`<option${(f.value===o)?' selected':''}>${o}</option>`).join('')}</select>`;
    if(f.type==="checkboxes") c=`<div>${(f.options||[]).map((o,i)=>`<label style='display:flex;gap:6px;align-items:center;margin:4px 0'><input type='checkbox' id="f_${f.id}_${i}"><span>${o}</span></label>`).join('')}</div>`;
    F.appendChild(el(`<label>${f.label||f.id}</label>`)); F.appendChild(el(c));
  });
  $("#secImgs").style.display=IMG_CATS.has(ex.cat)?"":"none";
  renderThumbs(ex); render();
}

function autoConclusion(p){const n=parseFloat(p); if(isNaN(n)) return ""; if(n>=99) return `Compat√≠vel com v√≠nculo biol√≥gico (probabilidade de ${n}%).`;
  if(n>=90) return `Altamente sugestivo de v√≠nculo biol√≥gico (probabilidade de ${n}%).`; return `N√£o compat√≠vel com v√≠nculo biol√≥gico (probabilidade de ${n}%).`;
}
function section(v,title,fid){v.appendChild(el(`<div class='hr'></div>`)); v.appendChild(el(`<div class="section-title"><span class="dot"></span><strong>${title}</strong></div>`));
  const box=el(`<div class='box'></div>`); const ta=$("#f_"+fid); box.innerHTML=(ta?.value||"").replace(/\n/g,"<br>"); v.appendChild(box);
}

function render(){
  const unidVal=(unidSel.value==="Outra..."?(unid.value||"‚Äî"):unidSel.value);
  $("#v_unid").textContent=unidVal; $("#v_data").textContent=$("#data").value||"‚Äî";
  $("#v_paciente").textContent=$("#paciente").value||"‚Äî"; $("#v_doc").textContent=$("#doc").value||"‚Äî"; $("#v_idade").textContent=$("#idade").value||"‚Äî";
  $("#v_sangue").textContent=$("#sangue").value||"‚Äî"; $("#v_contato").textContent=$("#contato").value||"‚Äî";
  $("#v_medico").textContent=$("#medico").value||"‚Äî"; $("#v_crm").textContent=$("#crm").value||"‚Äî"; $("#sigM").textContent=$("#medico").value||"‚Äî"; $("#sigC").textContent=$("#crm").value||"‚Äî";
  $("#v_num").textContent=Date.now().toString().slice(-8); $("#v_code").textContent=Math.random().toString(36).slice(2,10).toUpperCase();
  refreshSig();
  const ex=current; const v=$("#view"); v.innerHTML=""; if(!ex){v.textContent="Selecione um exame."; return;}
  const g=el(`<div class='grid3'></div>`);
  ex.fields.forEach(f=>{
    if(f.type==="textarea"||f.type==="dynamic") return; let val="‚Äî";
    if(f.type==="checkboxes"){const arr=[]; (f.options||[]).forEach((o,i)=>{const cb=$("#f_"+f.id+"_"+i); if(cb&&cb.checked) arr.push(o);}); val=arr.join(" ‚Ä¢ ")||"‚Äî";}
    else{const elv=$("#f_"+f.id); if(elv) val=elv.value||"‚Äî";}
    if(f.type==="input"||f.type==="select"||f.type==="checkboxes"){g.appendChild(el(`<div class='box'><div class='small'>${f.label||f.id}</div><div style='font-weight:800'>${val}</div></div>`));}
  });
  if(g.children.length) v.appendChild(g);

  const order=["queixa","neuro","param","ach","achados","alin","espacos","list","art","comp","alca","ar","refer","interpret","interpre","valores","laudo","imp","conduta","orient","texto","obs","biometria","anatomia","valvas","cam","curvas","reac","res","trat","orgaos"];
  const used=new Set(); order.forEach(fid=>{const F=(ex.fields||[]).find(ff=>ff.id===fid); if(F){used.add(fid); section(v,(F.label||fid[0].toUpperCase()+fid.slice(1)),fid);}});
  (ex.fields||[]).forEach(F=>{if(F.type==="textarea"&&!used.has(F.id)) section(v,(F.label||F.id),F.id);});

  if(ex.id==="lab_dna"){
    const tbl=el(`<div class='box' style='margin-top:8px'><div class='table'><header><div>Participante</div><div>Parentesco</div><div>Amostra</div></header><div id='dnaRows'></div></div></div>`);
    v.prepend(tbl); const rows=document.querySelectorAll("#dyn_participantes .row"); const container=tbl.querySelector("#dnaRows");
    rows.forEach(r=>{const ins=r.querySelectorAll("input"); container.appendChild(el(`<div class='row'><div>${ins[0].value||"‚Äî"}</div><div>${ins[1].value||"‚Äî"}</div><div>${ins[2].value||"‚Äî"}</div></div>`));});
    const prob=$("#f_prob")?.value||""; const auto=autoConclusion(prob);
    v.appendChild(el(`<div class='box' style='margin-top:8px'><span class='badge-soft'>Conclus√£o</span><div style='margin-top:6px'>${auto||"‚Äî"}</div></div>`));
  }
  buildGallery(ex);
}

// din√¢mico DNA
function buildDynamic(fid){
  const wrap=el(`<div id="dyn_${fid}"><label>Participantes (Nome, Parentesco, Amostra)</label><div id="dyn_${fid}_list"></div><div class="controls" style="margin-top:6px"><button class="btn" type="button" onclick="addDynRow('${fid}')">+ Adicionar</button></div></div>`);
  $("#fields").appendChild(wrap); addDynRow(fid); addDynRow(fid);
}
function addDynRow(fid){const list=$("#dyn_"+fid+"_list"); const row=el(`<div class="grid3 row"><input placeholder="Nome"><input placeholder="Parentesco"><input placeholder="Amostra"></div>`); list.appendChild(row);}

["data","paciente","doc","idade","sangue","contato","medico","crm"].forEach(id=>{$("#"+id).oninput=render;});
$("#bRender").onclick=render;

$("#bPNG").onclick=async()=>{const node=$("#paper"); const canvas=await html2canvas(node,{scale:2,backgroundColor:"#fff"}); const dataURL=canvas.toDataURL("image/png"); const a=$("#dl"); a.href=dataURL; a.click();};

(function init(){
  const catSel=$("#cat"); ["Todas",...CATS].forEach(c=>catSel.appendChild(el(`<option value="${c}">${c}</option>`)));
  buildList(); catSel.value="Todas"; buildList();
  const def="rx_torax"; const ex=CATALOG.find(x=>x.id===def)||CATALOG[0]; selectExam(ex.id); render();
})();
</script>
</body>
</html>
